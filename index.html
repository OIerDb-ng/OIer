<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"/>
		<link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<link rel="stylesheet" href="style.css"/>
		<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		<script src="chart.js"></script><script src="mychart.js"></script>
		
	</head>
	<body>
		<title>OierDb</title>
		<div id = "school" class = "win" style = "flex-flow: column;display:flex;">
			<div>
			<h2>江苏省苏州中学园区校</h2>
			<button onclick = "document.getElementById('school').style = 'display:none'" class = "sqrbtn extbtn fa fa-mail-reply"></button>
			<p>又名 苏州中学园区校 / 苏州高级中学园区校 。评级：AAAAA级</p>
			<hr/>
			</div>
			<div style = "text-align:center;" >
				<div class="btn-group" role="group" aria-label="...">
					<button type="button" class="btn minebtn minebtn-ac">NOIP普及</button>
					<button type="button" class="btn minebtn">NOIP提高</button>
					<button type="button" class="btn minebtn">APIO</button>
					<button type="button" class="btn minebtn">CTSC</button>
					<button type="button" class="btn minebtn minebtn-ac">NOI</button>
					<button type="button" class="btn minebtn">WC</button>
				</div>
			</div>
			<br/>
			<div style = "flex: 1">
				<canvas id="canvas" style = "background:#ffffff"></canvas>
			</div>
		</div>
		<div id="container" style = "text-align:center;">
			<object data="logo.svg" type="image/svg+xml" display:"inline-block" style = "width:80%"></object>
			<div class="search bar8">
				<div class = "cof">
					<input type="text" id = "infoinput" placeholder="请输入以空格分割的信息..."/>
					<button onclick = "search()" class = "sqrbtn"></button>
				</div>
			</div>
			<br/><br/>
			<div id = "dataArea" style = "display:">
				<table class="table" style = "color:white">
					<thead>
						<tr>
							<th>姓名</th>
							<th>省份</th>
							<th>年级</th>
							<th>获奖记录</th>
						</tr>
					</thead>
					<tbody id = "resultArea">
						<tr><td colspan="4">
							
						</td></tr>
					</tbody>
				</table>
			</div>
		</div>
		
		<script>
			var year = ["五年级","六年级","初一","初二","初三","高一","高二","高三","高中毕业","高中毕业","高中毕业","高中毕业","高中毕业","高中毕业"];
			var contests = {"NOIP提高":11,"NOIP普及":11,"APIO":5.3,"CTSC":5.6,"NOI":7,"WC":1}
			var cacheData;
			var awards;
			function sortby(a,b){
				return parseInt(a["identity"].match(/[0-9]{4}/))+contests[a["ctype"]]/12.0<parseInt(b["identity"].match(/[0-9]{4}/))+contests[b["ctype"]]/12.0;
			}
		function datacmp(a,b){
			return a['awards'].length<b['awards'].length;
		}
		function getGrade(s){
			var yea = year[s];
			if(yea == undefined) yea = "----";
			return yea;
		}
		function showSchoolInfo(s){
			alert(s);
		}
		function search(){
			var XMLHttp=new XMLHttpRequest()
			XMLHttp.open("GET","http://bytew.net/OIer/search.php?q="+document.getElementById("infoinput").value,true);
			XMLHttp.send();
			XMLHttp.onreadystatechange=function(){
				if (XMLHttp.readyState==4 && XMLHttp.status==200){
					if(XMLHttp.responseText!=""){
						var ra = document.getElementById("resultArea");
						document.getElementById("dataArea").style.display = "";
						ra.innerHTML = "";
						var datas = eval("(" + XMLHttp.responseText + ")")["result"];
						cacheData = datas;
						datas.sort(datacmp);
						for(var i in datas){
							var sf = [],sfc = "";
							
							awards = eval("(" + datas[i]["awards"] + ")");
							for(var j in awards){
								var cur_p = awards[j]["province"];
								if(sf.indexOf(cur_p)>=0) continue;
								sf.push(cur_p);
								if(sf.length>1)sfc+="/";
								sfc+=cur_p;
							}
							var yea = getGrade(2018-parseInt(datas[i]["year"]));
							var sex  = ["女","--","男"];
							var award_badges,award_detail;
							console.log(datas[i]["name"]);
							awards.sort(sortby);
							for(var each_award in awards){
								//TODO:Add Badges
							}
							awards.sort(sortby);
							award_detail = '<font style = "font-size:xx-large">'+datas[i]["name"]+'</font><font style = "font-size:large">,'+sex[parseInt(datas[i]["sex"])+1]+',现在'+yea+'</font><table class="table table-bordered" style = "color:white;background:#000;"><thead><tr><th>获奖</th><th>分数</th><th>全国排名</th><th>就读学校</th><th>年级</th></tr></thead>'
							for(var each_award in awards){
								var current_Award = awards[each_award];
								award_detail+='<tr><th scope = "row">'+current_Award["identity"]+current_Award["award_type"]+'</th><td>'+current_Award["score"]+'</td><td>'+current_Award["rank"]+'</td><td onclick = "showSchoolInfo('+current_Award["school_id"]+')" style = "cursor:pointer">'+current_Award["school"]+'</td><td>'+getGrade(1+parseInt(current_Award["grade"]))+'</td></tr>';
							}
							award_detail+='</table>'
							award_badges = "尚未完成的功能"
							ra.innerHTML+='<tr role="button" data-toggle="collapse" data-target="#'+datas[i]["id"]+'" aria-expanded="false" aria-controls="'+datas[i]["id"]+'"><th scope="row">'+datas[i]["name"]+'</th><td>'+sfc+'</td><td>'+yea+'</td><td>'+award_badges+'</td></tr>'
							ra.innerHTML+='<tr><td colspan="4"><div class="collapse" id = "'+datas[i]["id"]+'">'+award_detail+'</div></td></tr>'
						}
					}
				}
			}
		}
		</script>
	</body>
	
</html>
